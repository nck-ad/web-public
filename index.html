<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strength Tracker V6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES & CONSTANTS ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null; 
        let auth = null; 
        let userId = null;
        let isAuthReady = false;

        // --- DRAG AND DROP STATE ---
        let dragStartIndex = -1;

        // --- TIMER STATE ---
        let restTimerInterval = null;
        let restTimeSeconds = 90; 
        const MAX_REST_TIME = 90;
        let workoutTimerInterval = null;
        let totalTimeSeconds = 0;

        // --- CORE DATA ---
        const BASE_EXERCISE_LIBRARY = {
            'Goblet Squat': { goal: "3x10-12", type: 'Legs' },
            'Dumbbell Bench Press': { goal: "3x10-12", type: 'Push' },
            'Lat Pulldown': { goal: "3x10-12", type: 'Pull' },
            'Dumbbell Romanian Deadlift (RDL)': { goal: "3x10-12", type: 'Legs' },
            'Dumbbell Shoulder Press': { goal: "3x10-12", type: 'Push' },
            'Cable Row (Seated)': { goal: "3x10-12", type: 'Pull' },
            'Plank (Seconds)': { goal: "3x30-60 sec", type: 'Core', isTimed: true },
            'Cable Triceps Pushdown': { goal: "3x10-15", type: 'Push' },
            'Face Pulls': { goal: "3x15-20", type: 'Pull' },
            'Leg Press': { goal: "3x10-15", type: 'Legs' },
            'Dumbbell Bicep Curl': { goal: "3x10-12", type: 'Pull' }, 
            'Incline Dumbbell Press': { goal: "3x8-12", type: 'Push' },
            'Overhead Dumbbell Extension': { goal: "3x12-15", type: 'Push' },
            'Seated Calf Raise': { goal: "3x15-20", type: 'Legs' },
            'Chin-Ups (AMRAP)': { goal: "3xAMRAP", type: 'Pull' },
            'Reverse Lunge (DB)': { goal: "3x10-12", type: 'Legs' },
            'Ab Roller': { goal: "3x10-15", type: 'Core' },
        };

        let EXERCISE_LIBRARY = {}; // BASE_EXERCISE_LIBRARY + Custom Exercises
        let CUSTOM_PRESETS = {}; // User-defined workout routines

        const BASE_PRESETS = {
            'Full Body': ['Goblet Squat', 'Dumbbell Bench Press', 'Lat Pulldown', 'Dumbbell Romanian Deadlift (RDL)', 'Dumbbell Shoulder Press', 'Cable Row (Seated)', 'Plank (Seconds)'],
            'Push': ['Dumbbell Bench Press', 'Dumbbell Shoulder Press', 'Cable Triceps Pushdown', 'Leg Press', 'Plank (Seconds)'],
            'Pull': ['Lat Pulldown', 'Cable Row (Seated)', 'Face Pulls', 'Dumbbell Romanian Deadlift (RDL)', 'Dumbbell Bicep Curl'],
            'Legs': ['Goblet Squat', 'Leg Press', 'Dumbbell Romanian Deadlift (RDL)', 'Reverse Lunge (DB)', 'Seated Calf Raise'],
            'Core': ['Plank (Seconds)', 'Ab Roller', 'Cable Row (Seated)'],
        };

        let currentWorkout = {
            id: null,
            date: null,
            totalDuration: 0,
            presetName: 'Custom',
            notes: '',
            exercises: []
        };
        let workoutHistory = [];
        let exerciseCollapseState = {};

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            // Check if Firebase config is missing (EXPECTED in local file mode)
            if (Object.keys(firebaseConfig).length === 0) {
                userId = 'local-user-id-' + crypto.randomUUID().slice(0, 8);
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                document.getElementById('app-status').textContent = "Local Mode (No History/Sync)";

                EXERCISE_LIBRARY = { ...BASE_EXERCISE_LIBRARY }; 
                
                renderSidebarContent();
                startNewSession('Full Body'); 
                return; 
            } 
            
            // --- STANDARD FIREBASE INIT ---
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth failed:", error);
                document.getElementById('app-status').textContent = "Auth Error: See console.";
            }
            
            onAuthStateChanged(auth, async (user) => {
                userId = user.uid;
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                document.getElementById('app-status').textContent = "Ready";
                
                EXERCISE_LIBRARY = { ...BASE_EXERCISE_LIBRARY }; 
                await loadCustomExercises(); 
                await loadCustomPresets();
                
                renderSidebarContent(); 
                startNewSession('Full Body'); 
                loadHistory(); 
            });
        }

        // --- DATA INTERACTION (Presets & History) ---

        async function loadCustomPresets() {
            if (!isAuthReady || !db) return;

            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/custom_presets`);
            try {
                const querySnapshot = await getDocs(query(collectionRef));
                const customP = {};
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    customP[doc.id] = data.exercises; 
                });
                CUSTOM_PRESETS = customP;
            } catch (error) {
                console.error("Error loading custom presets:", error);
            }
        }
        
        async function saveCustomPreset(name) {
            if (!isAuthReady || !currentWorkout.exercises.length) {
                showMessage("Cannot save empty workout as a preset.", 'error');
                return;
            }
            if (!db) {
                showMessage("Database not initialized. Cannot save preset in Local Mode.", 'error');
                return;
            }
            
            const sanitizedName = name.trim();
            if (sanitizedName === "") {
                showMessage("Preset name cannot be empty.", 'error');
                return;
            }

            const exerciseNames = currentWorkout.exercises.map(ex => ex.name);

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/custom_presets`, sanitizedName);
                await setDoc(docRef, { exercises: exerciseNames });
                
                CUSTOM_PRESETS[sanitizedName] = exerciseNames;
                
                showMessage(`Custom preset '${sanitizedName}' saved!`, 'success');
                document.getElementById('new-preset-name').value = '';
                renderSidebarContent(); 

            } catch (error) {
                console.error("Error saving custom preset:", error);
                showMessage("Error saving custom preset. See console.", 'error');
            }
        }

        window.handleSavePreset = () => {
            const name = document.getElementById('new-preset-name').value;
            saveCustomPreset(name);
        };

        async function loadCustomExercises() {
            if (!isAuthReady || !db) return; 

            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/custom_exercises`);
            try {
                const querySnapshot = await getDocs(query(collectionRef));
                const customEx = {};
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    customEx[doc.id] = data; 
                });
                
                Object.assign(EXERCISE_LIBRARY, customEx);

            } catch (error) {
                console.error("Error loading custom exercises:", error);
            }
        }

        async function saveCustomExercise(name, goal, isTimed, type) {
            if (!isAuthReady) {
                showMessage("App not ready. Cannot save custom exercise.", 'error');
                return;
            }
            if (!db) {
                showMessage("Database not initialized. Cannot save custom exercise in Local Mode.", 'error');
                return;
            }
            
            const sanitizedName = name.trim();
            if (sanitizedName in EXERCISE_LIBRARY) {
                showMessage("An exercise with that name already exists.", 'error');
                return;
            }
            if (sanitizedName === "") {
                showMessage("Exercise name cannot be empty.", 'error');
                return;
            }

            const newExercise = {
                goal: goal || "Custom goal",
                type: type || "Misc",
                isTimed: isTimed,
            };
            
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/custom_exercises`, sanitizedName);
                await setDoc(docRef, newExercise);
                
                EXERCISE_LIBRARY[sanitizedName] = newExercise;
                
                showMessage(`Custom exercise '${sanitizedName}' saved and available!`, 'success');
                
                // Clear form and refresh sidebar
                document.getElementById('custom-exercise-name').value = '';
                document.getElementById('custom-exercise-goal').value = '';
                document.getElementById('custom-exercise-type').value = '';
                document.getElementById('custom-exercise-timed').checked = false;

                renderSidebarContent(); 
                if (currentWorkout.id) renderTracker();

            } catch (error) {
                console.error("Error saving custom exercise:", error);
                showMessage("Error saving custom exercise. See console.", 'error');
            }
        }
        
        window.handleCreateCustomExercise = () => {
            const name = document.getElementById('custom-exercise-name').value;
            const goal = document.getElementById('custom-exercise-goal').value;
            const type = document.getElementById('custom-exercise-type').value;
            const isTimed = document.getElementById('custom-exercise-timed').checked;
            
            saveCustomExercise(name, goal, isTimed, type);
        };
        
        function getWorkoutPath(sessionId) {
            return `artifacts/${appId}/users/${userId}/workout_sessions/${sessionId}`;
        }

        async function saveWorkout() {
            if (!isAuthReady || !currentWorkout.id) {
                showMessage("Authentication or session ID is missing. Cannot save.", 'error');
                return;
            }
            
            stopWorkoutTimer();
            currentWorkout.totalDuration = totalTimeSeconds;

            if (!db) {
                 showMessage("Database not initialized. Saving workout locally only (will not persist).", 'info');
                 workoutHistory.unshift(JSON.parse(JSON.stringify(currentWorkout)));
                 showMessage("Workout finished (Local save only). Start a new session.", 'success');
                 return;
            }
            
            const sessionData = {
                date: currentWorkout.date,
                totalDuration: currentWorkout.totalDuration,
                presetName: currentWorkout.presetName,
                exercises: currentWorkout.exercises,
                notes: currentWorkout.notes
            };

            try {
                const docRef = doc(db, getWorkoutPath(currentWorkout.id));
                await setDoc(docRef, sessionData);
                showMessage("Workout saved successfully! Start a new session.", 'success');
                loadHistory(); 
            } catch (error) {
                console.error("Error saving document: ", error);
                showMessage("Error saving workout. See console.", 'error');
            }
        }

        async function loadHistory() {
            if (!isAuthReady || !db) return; 

            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/workout_sessions`);
            try {
                const querySnapshot = await getDocs(query(collectionRef));
                
                const loadedData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    loadedData.push({ id: doc.id, ...data });
                });

                workoutHistory = loadedData.sort((a, b) => new Date(b.date) - new Date(a.date));
                if (document.getElementById('history-view').classList.contains('hidden') === false) {
                     renderHistory();
                }

            } catch (error) {
                console.error("Error loading history: ", error);
                showMessage("Error loading workout history. See console.", 'error');
            }
        }


        // --- APP LOGIC ---
        function startNewSession(presetName, isCustom = false) {
            resetRestTimer();
            stopWorkoutTimer();
            totalTimeSeconds = 0; 
            startWorkoutTimer();
            
            currentWorkout.id = crypto.randomUUID();
            currentWorkout.date = new Date().toISOString();
            currentWorkout.notes = '';
            currentWorkout.presetName = presetName;
            
            let exerciseNames;
            if (isCustom) {
                exerciseNames = CUSTOM_PRESETS[presetName] || [];
            } else {
                exerciseNames = BASE_PRESETS[presetName] || BASE_PRESETS['Full Body'];
            }
            
            currentWorkout.exercises = exerciseNames.map(name => ({
                name: name,
                sets: [{}, {}, {}], 
                goal: EXERCISE_LIBRARY[name]?.goal || "3x?", 
                type: EXERCISE_LIBRARY[name]?.type || "Misc"
            }));
            
            // Initialize collapse state
            exerciseCollapseState = currentWorkout.exercises.reduce((acc, _, index) => {
                acc[index] = index === 0;
                return acc;
            }, {});

            const notesElement = document.getElementById('session-notes');
            if (notesElement) notesElement.value = '';

            renderTracker();
            showMessage(`New '${presetName}' session started!`, 'info');
            toggleSidebar(false); 
        }

        window.startPreset = (name, isCustom) => {
            startNewSession(name, isCustom);
        };

        // --- UI RENDERING (Sidebar) ---

        function renderSidebarContent() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;

            // 1. Build Exercise Dropdown Options
            const exerciseNames = Object.keys(EXERCISE_LIBRARY).sort();
            const exerciseOptions = exerciseNames.map(name => 
                `<option value="${name}">${name} (${EXERCISE_LIBRARY[name].type}${EXERCISE_LIBRARY[name].isTimed ? ' - TIMED' : ''})</option>`
            ).join('');

            // 2. Build Preset Buttons
            const basePresetsHTML = Object.keys(BASE_PRESETS).map(name => 
                `<button onclick="window.startPreset('${name}', false)" class="p-2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg shadow-sm transition text-sm">${name}</button>`
            ).join('');

            const customPresetsHTML = Object.keys(CUSTOM_PRESETS).length > 0 ? `
                <h4 class="text-md font-semibold text-purple-700 mt-4 mb-2">My Custom Presets:</h4>
                <div class="grid grid-cols-2 gap-2">
                    ${Object.keys(CUSTOM_PRESETS).map(name => 
                        `<button onclick="window.startPreset('${name}', true)" class="p-2 bg-purple-500 hover:bg-purple-600 text-white font-bold rounded-lg shadow-sm transition text-xs">${name}</button>`
                    ).join('')}
                </div>
            ` : '';

            sidebar.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-extrabold text-indigo-800">Control Panel</h2>
                    <button onclick="window.toggleSidebar(false)" class="lg:hidden p-1 rounded-full text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <!-- 1. Start Session / Presets -->
                <div class="mb-8 border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Start New Session:</h3>
                    <div class="grid grid-cols-2 gap-2">
                        ${basePresetsHTML}
                    </div>
                    ${customPresetsHTML}
                </div>

                <!-- 2. Save Current as Preset -->
                <div class="mb-8 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-3">Save Current as Preset</h3>
                    <p class="text-xs text-gray-600 mb-2">Saves the current order of exercises.</p>
                    <div class="space-y-2">
                        <input type="text" id="new-preset-name" placeholder="Preset Name (e.g., Upper A)" class="w-full p-2 border rounded-md text-sm">
                        <button onclick="window.handleSavePreset()"
                                class="w-full p-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition text-sm">
                            Save Preset
                        </button>
                    </div>
                </div>

                <!-- 3. Add Individual Exercise -->
                <div class="mb-8 border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Add Exercise to Current Session</h3>
                    <div class="space-y-2">
                        <select id="new-exercise-select" class="w-full p-2 border border-gray-300 rounded-md focus:border-indigo-500 transition text-sm">
                            <option value="">-- Select Exercise --</option>
                            ${exerciseOptions}
                        </select>
                        <button onclick="window.addExerciseToCurrentSession(document.getElementById('new-exercise-select').value)"
                                class="w-full p-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded-lg shadow-md transition text-sm">
                            + Add to Workout
                        </button>
                    </div>
                </div>

                <!-- 4. Create Custom Exercise -->
                <div class="mb-8 p-3 bg-gray-100 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Create New Exercise</h3>
                    <div class="space-y-3">
                        <input type="text" id="custom-exercise-name" placeholder="Exercise Name (e.g., Weighted Sit-up)" class="w-full p-2 border rounded-md text-sm">
                        <input type="text" id="custom-exercise-goal" placeholder="Goal (e.g., 3x10-15)" class="w-full p-2 border rounded-md text-sm">
                        <input type="text" id="custom-exercise-type" placeholder="Type (e.g., Core, Back)" class="w-full p-2 border rounded-md text-sm">
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="custom-exercise-timed" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="custom-exercise-timed" class="ml-2 block text-sm font-medium text-gray-700">
                                Timed Exercise
                            </label>
                        </div>
                        
                        <button onclick="window.handleCreateCustomExercise()"
                                class="w-full p-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition text-sm">
                            Save Custom Exercise
                        </button>
                    </div>
                </div>
            `;
        }
        
        // --- DRAG AND DROP HANDLERS ---
        window.handleDragStart = (exIndex, event) => {
            dragStartIndex = exIndex;
            event.dataTransfer.effectAllowed = 'move';
            // Set a unique data attribute to avoid drag issues
            event.dataTransfer.setData('text/plain', exIndex);
            setTimeout(() => {
                event.target.classList.add('opacity-50', 'bg-indigo-100', 'shadow-xl');
            }, 0);
        };

        window.handleDragOver = (event) => {
            event.preventDefault(); // Necessary to allow drop
            event.dataTransfer.dropEffect = 'move';
        };

        window.handleDragEnter = (event) => {
            event.preventDefault();
            const target = event.currentTarget;
            target.classList.add('border-indigo-500', 'border-dashed');
        };

        window.handleDragLeave = (event) => {
            event.currentTarget.classList.remove('border-indigo-500', 'border-dashed');
        };

        window.handleDrop = (targetIndex, event) => {
            event.preventDefault();
            event.currentTarget.classList.remove('border-indigo-500', 'border-dashed');
            
            const draggedIndex = parseInt(event.dataTransfer.getData('text/plain'));
            
            if (draggedIndex !== targetIndex && dragStartIndex !== -1) {
                const exerciseToMove = currentWorkout.exercises[draggedIndex];
                
                // Remove from old position and insert at new position
                currentWorkout.exercises.splice(draggedIndex, 1);
                currentWorkout.exercises.splice(targetIndex, 0, exerciseToMove);
                
                // Re-index collapse state
                const newCollapseState = {};
                currentWorkout.exercises.forEach((_, index) => {
                    newCollapseState[index] = exerciseCollapseState[index] || false;
                });
                exerciseCollapseState = newCollapseState;

                renderTracker();
                showMessage(`Moved ${exerciseToMove.name}`, 'info');
            }
            dragStartIndex = -1; // Reset drag state
        };

        window.handleDragEnd = (event) => {
            event.target.classList.remove('opacity-50', 'bg-indigo-100', 'shadow-xl');
            dragStartIndex = -1;
            // Ensure all elements lose the border in case of a failed drop
            document.querySelectorAll('.exercise-draggable').forEach(el => {
                el.classList.remove('border-indigo-500', 'border-dashed');
            });
        };

        // --- UI RENDERING (Tracker) ---
        function renderTracker() {
            const container = document.getElementById('tracker-container');
            
            container.innerHTML = `
                <!-- Current Session Header -->
                <div class="p-4 bg-gray-100 rounded-xl mb-6 flex justify-between items-center shadow-inner border-t-4 border-indigo-700">
                    <span class="font-semibold text-lg text-indigo-700">Session: ${currentWorkout.presetName}</span>
                    <span class="text-sm">${new Date(currentWorkout.date).toLocaleDateString()}</span>
                </div>
                
                <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">Exercises (Drag to reorder)</h3>
            `;
            
            currentWorkout.exercises.forEach((ex, exIndex) => {
                const isTimed = EXERCISE_LIBRARY[ex.name]?.isTimed || false;
                const isExpanded = exerciseCollapseState[exIndex];
                
                let setInputsHTML = ex.sets.map((set, setIndex) => {
                    let inputFields;
                    
                    if (isTimed) {
                        inputFields = `
                            <input type="number" placeholder="Time Held" min="0" 
                                value="${set.reps !== null && set.reps !== undefined ? set.reps : ''}" 
                                oninput="window.handleInputChange(${exIndex}, ${setIndex}, 'reps', this.value)"
                                class="flex-grow p-2 border border-gray-300 rounded-md text-center focus:border-indigo-500 focus:ring-indigo-200 transition">
                            <span class="w-12 flex-shrink-0 text-gray-500 text-sm">secs</span>
                        `;
                    } else {
                        inputFields = `
                            <input type="number" placeholder="Reps" min="0" 
                                value="${set.reps !== null && set.reps !== undefined ? set.reps : ''}" 
                                oninput="window.handleInputChange(${exIndex}, ${setIndex}, 'reps', this.value)"
                                class="w-1/2 p-2 border border-gray-300 rounded-md text-center focus:border-indigo-500 focus:ring-indigo-200 transition">
                            <input type="number" placeholder="Weight (kg)" min="0" step="0.5" 
                                value="${set.weight !== null && set.weight !== undefined ? set.weight : ''}" 
                                oninput="window.handleInputChange(${exIndex}, ${setIndex}, 'weight', this.value)"
                                class="w-1/2 p-2 border border-gray-300 rounded-md text-center focus:border-indigo-500 focus:ring-indigo-200 transition">
                            <span class="w-12 flex-shrink-0 text-gray-500 text-sm">kg</span>
                        `;
                    }
                    
                    return `
                        <div class="flex space-x-2 mb-2 items-center">
                            <span class="w-16 flex-shrink-0 font-medium text-gray-600 text-left">Set ${setIndex + 1}:</span>
                            ${inputFields}
                        </div>
                    `;
                }).join('');
                
                const collapseClass = isExpanded ? 'collapsible-content expanded' : 'collapsible-content';

                let exerciseHTML = `
                    <div class="exercise-draggable mb-6 p-4 bg-white rounded-xl shadow-lg border-l-4 border-indigo-500 transition-all duration-200" 
                         draggable="true" 
                         data-index="${exIndex}"
                         ondragstart="window.handleDragStart(${exIndex}, event)"
                         ondragover="window.handleDragOver(event)"
                         ondragenter="window.handleDragEnter(event)"
                         ondragleave="window.handleDragLeave(event)"
                         ondrop="window.handleDrop(${exIndex}, event)"
                         ondragend="window.handleDragEnd(event)">
                        
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center flex-grow min-w-0">
                                <span class="drag-handle text-gray-400 hover:text-indigo-600 cursor-move text-xl mr-2" title="Drag to reorder">
                                    &#x2261;
                                </span>
                                <h3 class="text-xl font-bold text-gray-800 flex items-center min-w-0 flex-shrink truncate cursor-pointer" onclick="window.toggleExerciseCard(${exIndex})">
                                    ${ex.name} 
                                    <span class="text-sm font-medium text-indigo-500 ml-2">${ex.goal}</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 text-gray-400 transform transition-transform duration-200 flex-shrink-0" 
                                        viewBox="0 0 20 20" fill="currentColor" style="transform: rotate(${isExpanded ? 0 : -90}deg);">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </h3>
                            </div>

                            <button onclick="event.stopPropagation(); window.removeExerciseFromCurrentSession(${exIndex})"
                                class="text-red-500 hover:text-red-700 font-semibold text-xs border border-red-500 rounded-full px-2 py-1 transition flex-shrink-0 ml-4">
                                Remove
                            </button>
                        </div>
                        
                        <div id="exercise-sets-${exIndex}" class="${collapseClass}">
                            ${setInputsHTML}
                        </div>
                    </div>
                `;
                container.innerHTML += exerciseHTML;
            });
            
            container.innerHTML += `
                <div class="mb-20 p-4 bg-white rounded-xl shadow-lg border-l-4 border-purple-500">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">Session Notes (NSVs)</h3>
                    <textarea id="session-notes" rows="3" placeholder="How did you feel? Energy low? Strength up? Any pains or new weights used?"
                        oninput="window.handleNotesChange(this.value)"
                        class="w-full p-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring focus:ring-purple-200 focus:ring-opacity-50 transition">${currentWorkout.notes}</textarea>
                </div>
            `;
            
            document.getElementById('save-button').onclick = saveWorkout;
            updateWorkoutTimerDisplay();
        }

        // --- EXERCISE MANAGEMENT ---
        function addExerciseToCurrentSession(name) {
            if (!name) {
                showMessage("Please select an exercise to add.", 'error');
                return;
            }
            const exerciseData = EXERCISE_LIBRARY[name];
            if (!exerciseData) {
                 showMessage(`Exercise '${name}' not found in library.`, 'error');
                return;
            }

            const newExIndex = currentWorkout.exercises.length;
            currentWorkout.exercises.push({
                name: name,
                sets: [{}, {}, {}],
                goal: exerciseData.goal,
                type: exerciseData.type
            });
            currentWorkout.presetName = 'Custom';

            exerciseCollapseState[newExIndex] = true;

            renderTracker();
            showMessage(`Added ${name} to session.`, 'info');
        }

        function removeExerciseFromCurrentSession(exIndex) {
            currentWorkout.exercises.splice(exIndex, 1);
            currentWorkout.presetName = 'Custom';
            
            // Re-index collapse state
            const newCollapseState = {};
            currentWorkout.exercises.forEach((_, index) => {
                newCollapseState[index] = exerciseCollapseState[index] || false;
            });
            exerciseCollapseState = newCollapseState;

            renderTracker();
            showMessage(`Exercise removed.`, 'info');
        }

        window.toggleExerciseCard = (exIndex) => {
            exerciseCollapseState[exIndex] = !exerciseCollapseState[exIndex];
            renderTracker(); 
        };

        // --- HELPER FUNCTIONS ---
        function handleInputChange(exIndex, setIndex, field, value) {
            let numValue = parseFloat(value);
            if (field === 'reps' || field === 'weight') {
                if (value === "") {
                    numValue = null;
                } else if (isNaN(numValue) || numValue < 0) {
                    numValue = 0; 
                }
                currentWorkout.exercises[exIndex].sets[setIndex][field] = numValue;
            }
        }
        
        function handleNotesChange(value) {
            currentWorkout.notes = value;
        }

        function formatDuration(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function showMessage(text, type) {
            const messageBox = document.getElementById('message-box');
            if (!messageBox) return;

            messageBox.textContent = text;
            messageBox.className = 'p-3 rounded-lg text-white font-medium mb-4 transition-opacity duration-300';
            messageBox.classList.add(type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500');
            messageBox.style.opacity = 1;
            setTimeout(() => {
                messageBox.style.opacity = 0;
            }, 3000);
        }

        function toggleSidebar(shouldOpen) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (!sidebar || !overlay) return;
            
            const isMobile = window.innerWidth < 1024;
            if (shouldOpen === undefined) {
                shouldOpen = isMobile ? sidebar.classList.contains('-translate-x-full') : true;
            }
            
            const isMobileView = window.innerWidth < 1024;

            if (shouldOpen) {
                if (isMobileView) {
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('translate-x-0');
                    overlay.classList.remove('hidden');
                }
            } else {
                 if (isMobileView) {
                    sidebar.classList.add('-translate-x-full');
                    sidebar.classList.remove('translate-x-0');
                    overlay.classList.add('hidden');
                 }
            }
        }
        
        function navigate(view) {
            const trackerView = document.getElementById('tracker-view');
            const historyView = document.getElementById('history-view');
            const trackerTab = document.getElementById('tracker-tab');
            const historyTab = document.getElementById('history-tab');
            const saveButtonContainer = document.getElementById('save-button-container');

            if (!trackerView || !historyView || !trackerTab || !historyTab || !saveButtonContainer) return;

            if (view === 'tracker') {
                trackerView.classList.remove('hidden');
                historyView.classList.add('hidden');
                trackerTab.classList.add('bg-indigo-700', 'text-white');
                trackerTab.classList.remove('bg-gray-200', 'text-gray-700');
                historyTab.classList.remove('bg-indigo-700', 'text-white');
                historyTab.classList.add('bg-gray-200', 'text-gray-700');
                saveButtonContainer.classList.remove('hidden');
                renderTracker();
            } else {
                trackerView.classList.add('hidden');
                historyView.classList.remove('hidden');
                historyTab.classList.add('bg-indigo-700', 'text-white');
                historyTab.classList.remove('bg-gray-200', 'text-gray-700');
                trackerTab.classList.remove('bg-indigo-700', 'text-white');
                trackerTab.classList.add('bg-gray-200', 'text-gray-700');
                saveButtonContainer.classList.add('hidden');
                
                loadHistory(); 
            }
        }

        // --- HISTORY RENDERING ---
        function renderHistory() {
            const container = document.getElementById('history-container');

            if (!db) {
                container.innerHTML = '<p class="text-gray-500 italic text-center p-4">History is disabled in Local Mode. Start a session to try the tracker!</p>';
                return;
            }

            if (workoutHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic text-center p-4">No workout history found yet. Complete a session to see it here!</p>';
                return;
            }

            container.innerHTML = workoutHistory.map(session => {
                const dateStr = new Date(session.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const durationStr = formatDuration(session.totalDuration || 0);
                const presetLabel = session.presetName || 'N/A';
                
                return `
                    <div class="mb-4 p-4 bg-white rounded-xl shadow-md border-l-4 border-green-500 cursor-pointer hover:bg-gray-50 transition" onclick="window.viewSessionDetail('${session.id}')">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="text-lg font-bold text-gray-800">
                                ${presetLabel} Workout
                            </h4>
                            <span class="text-sm font-semibold text-green-700">${durationStr} Total</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">${dateStr}</p>
                        <p class="text-xs text-gray-700 mb-3 truncate">Notes: ${session.notes || 'N/A'}</p>
                    </div>
                `;
            }).join('');
        }
        
        window.viewSessionDetail = (sessionId) => {
            const session = workoutHistory.find(s => s.id === sessionId);
            if (!session) return;

            const container = document.getElementById('history-container');
            
            container.innerHTML = `
                <button onclick="window.navigate('history')" class="mb-4 text-indigo-600 hover:text-indigo-800 font-semibold flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to History
                </button>
                <div class="mb-6 p-4 bg-white rounded-xl shadow-lg border-l-4 border-indigo-700">
                    <h4 class="text-xl font-bold text-gray-800 mb-1">${session.presetName} Workout (${formatDuration(session.totalDuration)})</h4>
                    <p class="text-sm text-gray-500 mb-3">${new Date(session.date).toLocaleString()}</p>
                    <p class="text-md font-semibold text-purple-700">Notes:</p>
                    <p class="text-gray-700 mb-4">${session.notes || 'No notes recorded.'}</p>
                    
                    <div class="space-y-3">
                        ${session.exercises.map(ex => {
                            const isTimed = EXERCISE_LIBRARY[ex.name]?.isTimed || false;
                            const unit = isTimed ? 's' : 'kg';
                            
                            const setDetails = ex.sets.map((set, i) => {
                                if (set.reps !== null && set.reps !== undefined) {
                                    if (isTimed) {
                                        return `<span class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">Set ${i+1}: ${set.reps}${unit}</span>`;
                                    } else {
                                        const weight = set.weight !== null && set.weight !== undefined ? ` @ ${set.weight}${unit}` : '';
                                        return `<span class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">Set ${i+1}: ${set.reps} reps${weight}</span>`;
                                    }
                                }
                                return '';
                            }).filter(s => s).join(' ');

                            return setDetails.length > 0 ? `
                                <div class="border-b pb-2">
                                    <p class="font-bold text-indigo-700 mb-1">${ex.name} (${ex.goal})</p>
                                    <div class="flex flex-wrap gap-2">${setDetails}</div>
                                </div>
                            ` : '';
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // --- TIMER LOGIC ---
        function updateRestTimerDisplay() {
            const display = document.getElementById('rest-timer-display');
            const minutes = Math.floor(restTimeSeconds / 60);
            const seconds = restTimeSeconds % 60;
            display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const status = document.getElementById('rest-timer-status');
            const button = document.getElementById('rest-timer-start-pause');
            
            if (!display || !status || !button) return;

            if (restTimeSeconds <= 0) {
                clearInterval(restTimerInterval);
                restTimerInterval = null;
                display.classList.add('bg-red-500', 'text-white', 'p-2', 'rounded', 'animate-pulse');
                status.textContent = "REST TIME OVER!";
                button.textContent = "Start Next Rest";
                button.onclick = startRestTimer;
            } else {
                display.classList.remove('bg-red-500', 'text-white', 'p-2', 'rounded', 'animate-pulse');
                status.textContent = "Resting...";
            }
        }

        function startRestTimer() {
            if (restTimerInterval) return; 
            if (restTimeSeconds <= 0) {
                restTimeSeconds = MAX_REST_TIME; 
            }

            const button = document.getElementById('rest-timer-start-pause');
            if (button) {
                button.textContent = "Pause";
                button.onclick = pauseRestTimer;
            }
            
            restTimerInterval = setInterval(() => {
                restTimeSeconds--;
                updateRestTimerDisplay();
            }, 1000);
        }

        function pauseRestTimer() {
            clearInterval(restTimerInterval);
            restTimerInterval = null;
            const button = document.getElementById('rest-timer-start-pause');
            if (button) {
                button.textContent = "Resume";
                button.onclick = startRestTimer;
            }
            const status = document.getElementById('rest-timer-status');
            if (status) status.textContent = "Paused";
        }

        function resetRestTimer() {
            pauseRestTimer();
            restTimeSeconds = MAX_REST_TIME;
            updateRestTimerDisplay();
            const button = document.getElementById('rest-timer-start-pause');
            if (button) {
                button.textContent = "Start";
                button.onclick = startRestTimer;
            }
            const status = document.getElementById('rest-timer-status');
            if (status) status.textContent = "Ready (90s)";
        }

        function updateWorkoutTimerDisplay() {
            const display = document.getElementById('workout-timer-display');
            if (display) {
                const hours = Math.floor(totalTimeSeconds / 3600);
                const minutes = Math.floor((totalTimeSeconds % 3600) / 60);
                const seconds = totalTimeSeconds % 60;
                display.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function startWorkoutTimer() {
            if (workoutTimerInterval) return;
            workoutTimerInterval = setInterval(() => {
                totalTimeSeconds++;
                updateWorkoutTimerDisplay();
            }, 1000);
        }

        function stopWorkoutTimer() {
            clearInterval(workoutTimerInterval);
            workoutTimerInterval = null;
        }


        // --- WINDOW LOAD & INIT ---
        window.onload = () => {
            initializeFirebase();
            
            // Expose functions globally
            window.handleInputChange = handleInputChange;
            window.handleNotesChange = handleNotesChange;
            window.navigate = navigate;
            window.addExerciseToCurrentSession = addExerciseToCurrentSession;
            window.removeExerciseFromCurrentSession = removeExerciseFromCurrentSession;
            window.toggleSidebar = toggleSidebar;
            
            // Timers
            window.startRestTimer = startRestTimer;
            window.resetRestTimer = resetRestTimer;

            // History
            window.viewSessionDetail = viewSessionDetail;
            window.toggleExerciseCard = toggleExerciseCard;
            
            navigate('tracker'); 
            updateRestTimerDisplay(); 
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        #message-box {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
        }
        /* Hide number spin buttons */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        @media (max-width: 1023px) {
            #main-content {
                width: 100%;
                padding-bottom: 5rem; 
            }
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.expanded {
            max-height: 500px; 
            transition: max-height 0.3s ease-in;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .exercise-draggable {
            border: 2px solid transparent; /* default state */
        }
        .exercise-draggable[draggable="true"]:hover .drag-handle {
            color: #4f46e5; /* Tailwind indigo-600 */
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="message-box"></div>
    <div id="sidebar-overlay" onclick="window.toggleSidebar(false)" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

    <div class="flex">
        <!-- Sidebar / Off-Canvas Menu -->
        <div id="sidebar" 
             class="fixed top-0 left-0 w-64 h-full bg-white z-50 shadow-2xl transform transition-transform duration-300 p-4 overflow-y-auto 
                    -translate-x-full lg:translate-x-0 lg:relative lg:w-72 lg:flex-shrink-0 lg:border-r lg:shadow-none">
            <!-- Sidebar content rendered by renderSidebarContent() -->
        </div>

        <!-- Main Content Area -->
        <div id="main-content" class="flex-grow min-h-screen p-4">
            <div class="max-w-xl mx-auto">
                <!-- Header and Menu Button (visible on mobile) -->
                <header class="text-center mb-6 flex justify-between items-center lg:justify-center">
                    <button onclick="window.toggleSidebar(true)" class="lg:hidden p-2 rounded-full bg-indigo-500 text-white shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <h1 class="text-3xl font-extrabold text-indigo-800 lg:text-center">Strength Tracker V6</h1>
                    <div class="w-8 lg:hidden"></div> 
                </header>

                <!-- Auth Status -->
                <div class="mb-4 text-xs text-gray-600 text-center">
                    Status: <span id="app-status" class="font-medium text-blue-600">Initializing...</span> | 
                    <span id="user-id-display" class="break-words"></span>
                </div>

                <!-- Navigation Tabs -->
                <div class="flex mb-6 rounded-lg overflow-hidden shadow-md">
                    <button id="tracker-tab" onclick="navigate('tracker')" 
                            class="flex-1 p-3 text-center transition duration-200 font-bold bg-indigo-700 text-white">
                        Current Workout
                    </button>
                    <button id="history-tab" onclick="navigate('history')" 
                            class="flex-1 p-3 text-center transition duration-200 font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">
                        History Log
                    </button>
                </div>

                <!-- Workout Tracker View -->
                <div id="tracker-view">
                    
                    <!-- Timers Container -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="p-4 bg-white rounded-xl shadow-lg border-b-4 border-green-500 text-center">
                            <h2 class="text-sm font-bold text-green-600 mb-1">Total Session Time</h2>
                            <span id="workout-timer-display" class="text-2xl font-extrabold text-gray-800 md:text-3xl">00:00:00</span>
                        </div>

                        <div class="p-4 bg-white rounded-xl shadow-lg border-b-4 border-indigo-400 text-center">
                            <h2 class="text-sm font-bold text-indigo-600 mb-1">Rest Timer (90s)</h2>
                            <span id="rest-timer-display" class="text-2xl font-extrabold text-gray-800 md:text-3xl">01:30</span>
                            <div class="flex justify-center mt-2 space-x-2">
                                <button id="rest-timer-start-pause" onclick="startRestTimer()" class="text-xs py-1 px-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-md transition">Start</button>
                                <button onclick="resetRestTimer()" class="text-xs py-1 px-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-md transition">Reset</button>
                            </div>
                        </div>
                    </div>
                    
                    <p id="rest-timer-status" class="text-sm text-gray-500 font-medium text-center mb-4">Ready (90s)</p>

                    <!-- Workout Exercise Tracker Container -->
                    <div id="tracker-container" class="space-y-4">
                        <!-- Exercises will be rendered here -->
                    </div>

                </div>

                <!-- History Log View -->
                <div id="history-view" class="hidden">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Recent Sessions</h3>
                    <div id="history-container" class="space-y-4">
                        <!-- History list or detail view rendered here -->
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Fixed Save Button Container -->
    <div id="save-button-container" class="fixed bottom-0 left-0 w-full p-4 bg-white border-t border-gray-200 shadow-2xl z-30 lg:relative lg:shadow-none lg:border-none lg:mt-4 lg:mb-4 lg:p-0">
        <div class="max-w-xl mx-auto">
            <button id="save-button" 
                    class="w-full py-3 px-10 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full shadow-xl transition duration-300 transform hover:scale-[1.01] flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                Save Workout & Finish
            </button>
        </div>
    </div>
    
</body>
</html>
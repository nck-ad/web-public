<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strength Tracker V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES & CONSTANTS ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // REST TIMER STATE
        let restTimerInterval = null;
        let restTimeSeconds = 90; 
        const MAX_REST_TIME = 90;

        // TOTAL WORKOUT CHRONOMETER STATE
        let workoutTimerInterval = null;
        let totalTimeSeconds = 0;
        let workoutStartTime = null;


        // --- WORKOUT DATA MODEL & LIBRARY ---
        // Expanded library including the missing item and a few extras for customization
        const EXERCISE_LIBRARY = {
            'Goblet Squat': { goal: "3x10-12", type: 'Legs' },
            'Dumbbell Bench Press': { goal: "3x10-12", type: 'Push' },
            'Lat Pulldown': { goal: "3x10-12", type: 'Pull' },
            'Dumbbell Romanian Deadlift (RDL)': { goal: "3x10-12", type: 'Legs' },
            'Dumbbell Shoulder Press': { goal: "3x10-12", type: 'Push' },
            'Cable Row (Seated)': { goal: "3x10-12", type: 'Pull' },
            'Plank (Seconds)': { goal: "3x30-60 sec", type: 'Core', isTimed: true },
            'Cable Triceps Pushdown': { goal: "3x10-15", type: 'Push' },
            'Face Pulls': { goal: "3x15-20", type: 'Pull' },
            'Leg Press': { goal: "3x10-15", type: 'Legs' },
            'Dumbbell Bicep Curl': { goal: "3x10-12", type: 'Pull' }, // FIX: Missing exercise
            'Incline Dumbbell Press': { goal: "3x8-12", type: 'Push' },
            'Overhead Dumbbell Extension': { goal: "3x12-15", type: 'Push' },
            'Seated Calf Raise': { goal: "3x15-20", type: 'Legs' },
            'Chin-Ups (AMRAP)': { goal: "3xAMRAP", type: 'Pull' },
            'Reverse Lunge (DB)': { goal: "3x10-12", type: 'Legs' },
            'Ab Roller': { goal: "3x10-15", type: 'Core' },
        };

        const PRESETS = {
            'Full Body': ['Goblet Squat', 'Dumbbell Bench Press', 'Lat Pulldown', 'Dumbbell Romanian Deadlift (RDL)', 'Dumbbell Shoulder Press', 'Cable Row (Seated)', 'Plank (Seconds)'],
            'Push': ['Dumbbell Bench Press', 'Dumbbell Shoulder Press', 'Cable Triceps Pushdown', 'Leg Press', 'Plank (Seconds)'],
            'Pull': ['Lat Pulldown', 'Cable Row (Seated)', 'Face Pulls', 'Dumbbell Romanian Deadlift (RDL)', 'Dumbbell Bicep Curl'],
            'Legs': ['Goblet Squat', 'Leg Press', 'Dumbbell Romanian Deadlift (RDL)', 'Reverse Lunge (DB)', 'Seated Calf Raise'],
            'Core': ['Plank (Seconds)', 'Ab Roller', 'Cable Row (Seated)'],
        };

        let currentWorkout = {
            id: null,
            date: null,
            totalDuration: 0, // In seconds, recorded on save
            presetName: 'Custom',
            notes: '',
            exercises: []
        };
        let workoutHistory = [];

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                document.getElementById('app-status').textContent = "Error: Firebase configuration missing.";
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth failed:", error);
                document.getElementById('app-status').textContent = "Auth Error: See console.";
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    document.getElementById('app-status').textContent = "Ready";
                    
                    // Initialize UI with a default or custom view
                    startNewSession('Full Body'); 
                    loadHistory();
                } else {
                    isAuthReady = false;
                    userId = null;
                    document.getElementById('app-status').textContent = "Awaiting Authentication...";
                }
            });
        }

        // --- DATA INTERACTION ---
        function getWorkoutPath(sessionId) {
            return `artifacts/${appId}/users/${userId}/workout_sessions/${sessionId}`;
        }

        async function saveWorkout() {
            if (!isAuthReady || !currentWorkout.id) {
                showMessage("Authentication or session ID is missing. Cannot save.", 'error');
                return;
            }
            
            // Stop chronometer and save total duration
            stopWorkoutTimer();
            currentWorkout.totalDuration = totalTimeSeconds;
            
            const sessionData = {
                date: currentWorkout.date,
                totalDuration: currentWorkout.totalDuration,
                presetName: currentWorkout.presetName,
                exercises: currentWorkout.exercises,
                notes: currentWorkout.notes
            };

            try {
                const docRef = doc(db, getWorkoutPath(currentWorkout.id));
                await setDoc(docRef, sessionData);
                showMessage("Workout saved successfully! Start a new session.", 'success');
                // Refresh history
                loadHistory(); 
            } catch (error) {
                console.error("Error saving document: ", error);
                showMessage("Error saving workout. See console.", 'error');
            }
        }

        async function loadHistory() {
            if (!isAuthReady) return;

            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/workout_sessions`);
            try {
                const querySnapshot = await getDocs(query(collectionRef));
                
                const loadedData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    loadedData.push({ id: doc.id, ...data });
                });

                workoutHistory = loadedData.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderHistory();

            } catch (error) {
                console.error("Error loading history: ", error);
                showMessage("Error loading workout history. See console.", 'error');
            }
        }

        // --- APP LOGIC ---

        function startNewSession(presetName) {
            resetRestTimer();
            stopWorkoutTimer();
            startWorkoutTimer();
            
            currentWorkout.id = crypto.randomUUID();
            currentWorkout.date = new Date().toISOString();
            currentWorkout.notes = '';
            currentWorkout.presetName = presetName;
            
            // Build the exercise list based on the preset
            const exerciseNames = PRESETS[presetName] || PRESETS['Full Body'];
            currentWorkout.exercises = exerciseNames.map(name => ({
                name: name,
                sets: [{}, {}, {}], // 3 sets default
                goal: EXERCISE_LIBRARY[name]?.goal || "3x?", // Use optional chaining for safety
                type: EXERCISE_LIBRARY[name]?.type || "Misc"
            }));

            // Clear notes field and render
            const notesElement = document.getElementById('session-notes');
            if (notesElement) {
                notesElement.value = '';
            }

            renderTracker();
            showMessage(`New '${presetName}' session started! Total timer running.`, 'info');
        }

        function handleInputChange(exIndex, setIndex, field, value) {
            let numValue = parseFloat(value);
            if (field === 'reps' || field === 'weight') {
                // Allow empty string for clearing input, otherwise validate
                if (value === "") {
                    numValue = null;
                } else if (isNaN(numValue) || numValue < 0) {
                    numValue = 0; 
                }
                currentWorkout.exercises[exIndex].sets[setIndex][field] = numValue;
            }
        }
        
        function handleNotesChange(value) {
            currentWorkout.notes = value;
        }
        
        // --- CUSTOMIZATION LOGIC ---

        function addExerciseToCurrentSession(name) {
            if (!name) {
                showMessage("Please select an exercise to add.", 'error');
                return;
            }
            const exerciseData = EXERCISE_LIBRARY[name];
            if (!exerciseData) {
                 showMessage(`Exercise '${name}' not found in library.`, 'error');
                return;
            }

            currentWorkout.exercises.push({
                name: name,
                sets: [{}, {}, {}],
                goal: exerciseData.goal,
                type: exerciseData.type
            });
            currentWorkout.presetName = 'Custom'; // Mark as custom once edited
            renderTracker();
            showMessage(`Added ${name} to session.`, 'info');
        }

        function removeExerciseFromCurrentSession(exIndex) {
            currentWorkout.exercises.splice(exIndex, 1);
            currentWorkout.presetName = 'Custom'; // Mark as custom once edited
            renderTracker();
            showMessage(`Exercise removed.`, 'info');
        }


        // --- REST TIMER LOGIC (90s Timer) ---
        function updateRestTimerDisplay() {
            const display = document.getElementById('rest-timer-display');
            const minutes = Math.floor(restTimeSeconds / 60);
            const seconds = restTimeSeconds % 60;
            display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const status = document.getElementById('rest-timer-status');
            const button = document.getElementById('rest-timer-start-pause');

            if (restTimeSeconds <= 0) {
                clearInterval(restTimerInterval);
                restTimerInterval = null;
                display.classList.add('bg-red-500', 'text-white', 'p-2', 'rounded');
                status.textContent = "REST TIME OVER!";
                button.textContent = "Start Next Rest";
                button.onclick = startRestTimer;
            } else {
                display.classList.remove('bg-red-500', 'text-white', 'p-2', 'rounded');
                status.textContent = "Resting...";
            }
        }

        function startRestTimer() {
            if (restTimerInterval) return; // Already running
            if (restTimeSeconds <= 0) {
                restTimeSeconds = MAX_REST_TIME; // Reset if it was at zero
            }

            document.getElementById('rest-timer-start-pause').textContent = "Pause";
            document.getElementById('rest-timer-start-pause').onclick = pauseRestTimer;
            
            restTimerInterval = setInterval(() => {
                restTimeSeconds--;
                updateRestTimerDisplay();
            }, 1000);
        }

        function pauseRestTimer() {
            clearInterval(restTimerInterval);
            restTimerInterval = null;
            document.getElementById('rest-timer-start-pause').textContent = "Resume";
            document.getElementById('rest-timer-start-pause').onclick = startRestTimer;
            document.getElementById('rest-timer-status').textContent = "Paused";
        }

        function resetRestTimer() {
            pauseRestTimer();
            restTimeSeconds = MAX_REST_TIME;
            updateRestTimerDisplay();
            document.getElementById('rest-timer-start-pause').textContent = "Start";
            document.getElementById('rest-timer-start-pause').onclick = startRestTimer;
            document.getElementById('rest-timer-status').textContent = "Ready (90s)";
        }

        // --- TOTAL WORKOUT TIMER (CHRONOMETER) LOGIC ---
        function updateWorkoutTimerDisplay() {
            const display = document.getElementById('workout-timer-display');
            if (display) {
                const hours = Math.floor(totalTimeSeconds / 3600);
                const minutes = Math.floor((totalTimeSeconds % 3600) / 60);
                const seconds = totalTimeSeconds % 60;
                display.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function startWorkoutTimer() {
            if (workoutTimerInterval) return;
            totalTimeSeconds = 0; // Reset for new session
            workoutTimerInterval = setInterval(() => {
                totalTimeSeconds++;
                updateWorkoutTimerDisplay();
            }, 1000);
        }

        function stopWorkoutTimer() {
            clearInterval(workoutTimerInterval);
            workoutTimerInterval = null;
        }


        // --- UI RENDERING ---

        function renderTracker() {
            const container = document.getElementById('tracker-container');
            
            // Build exercise customization dropdown options
            const exerciseOptions = Object.keys(EXERCISE_LIBRARY).sort().map(name => 
                `<option value="${name}">${name} (${EXERCISE_LIBRARY[name].type})</option>`
            ).join('');

            container.innerHTML = `
                <!-- Current Session Header -->
                <div class="p-4 bg-gray-100 rounded-lg mb-6 flex justify-between items-center shadow-inner border-t-4 border-indigo-700">
                    <span class="font-semibold text-lg text-indigo-700">Session: ${currentWorkout.presetName}</span>
                    <span class="text-sm">${new Date(currentWorkout.date).toLocaleDateString()}</span>
                </div>
                
                <!-- Customization Panel -->
                <div class="mb-6 p-4 bg-white rounded-xl shadow-lg border-l-4 border-gray-400">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">Customize Workout</h3>
                    <div class="flex space-x-2">
                        <select id="new-exercise-select" class="flex-1 p-2 border border-gray-300 rounded-md focus:border-indigo-500 transition">
                            <option value="">-- Select Exercise to Add --</option>
                            ${exerciseOptions}
                        </select>
                        <button onclick="window.addExerciseToCurrentSession(document.getElementById('new-exercise-select').value)"
                                class="p-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded-lg shadow-md transition whitespace-nowrap">
                            Add Exercise
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 italic">Removing/Adding exercises changes the preset to 'Custom'.</p>
                </div>
            `;
            
            // Render Exercises
            currentWorkout.exercises.forEach((ex, exIndex) => {
                const isTimed = EXERCISE_LIBRARY[ex.name]?.isTimed || false;
                const weightUnit = isTimed ? 'sec' : 'kg';
                const repsPlaceholder = isTimed ? 'Time Held' : 'Reps';
                const weightPlaceholder = isTimed ? 'N/A' : 'Weight';

                let exerciseHTML = `
                    <div class="mb-6 p-4 bg-white rounded-xl shadow-lg border-l-4 border-indigo-500">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-xl font-bold text-gray-800">${ex.name} 
                                <span class="text-sm font-medium text-indigo-500 ml-2">${ex.goal}</span>
                            </h3>
                            <button onclick="window.removeExerciseFromCurrentSession(${exIndex})"
                                class="text-red-500 hover:text-red-700 font-semibold text-xs border border-red-500 rounded-full px-2 py-1 transition">
                                Remove
                            </button>
                        </div>
                        
                        ${ex.sets.map((set, setIndex) => `
                            <div class="flex space-x-2 mb-2 items-center">
                                <span class="w-8 flex-shrink-0 font-medium text-gray-600">Set ${setIndex + 1}:</span>
                                
                                <input type="number" placeholder="${repsPlaceholder}" min="0" 
                                    value="${set.reps !== null && set.reps !== undefined ? set.reps : ''}" 
                                    oninput="window.handleInputChange(${exIndex}, ${setIndex}, 'reps', this.value)"
                                    class="w-1/3 p-2 border border-gray-300 rounded-md text-center focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition">
                                
                                <input type="number" placeholder="${weightPlaceholder}" min="0" step="0.5" 
                                    ${isTimed ? 'disabled' : ''}
                                    value="${set.weight !== null && set.weight !== undefined ? set.weight : ''}" 
                                    oninput="window.handleInputChange(${exIndex}, ${setIndex}, 'weight', this.value)"
                                    class="w-1/3 p-2 border border-gray-300 rounded-md text-center ${isTimed ? 'bg-gray-100 cursor-not-allowed' : 'focus:border-indigo-500 focus:ring focus:ring-indigo-200'} focus:ring-opacity-50 transition">
                                
                                <span class="w-12 flex-shrink-0 text-gray-500 text-sm">${isTimed ? 'secs' : 'kg'}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.innerHTML += exerciseHTML;
            });
            
            // Add notes section
            container.innerHTML += `
                <div class="mb-6 p-4 bg-white rounded-xl shadow-lg border-l-4 border-purple-500">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">Session Notes (NSVs)</h3>
                    <textarea id="session-notes" rows="3" placeholder="How did you feel? Energy low? Strength up? Any pains or new weights used?"
                        oninput="window.handleNotesChange(this.value)"
                        class="w-full p-2 border border-gray-300 rounded-md focus:border-purple-500 focus:ring focus:ring-purple-200 focus:ring-opacity-50 transition">${currentWorkout.notes}</textarea>
                </div>
            `;
            
            // Re-link action buttons
            document.getElementById('save-button').onclick = saveWorkout;
            
            // Ensure workout timer is visible
            updateWorkoutTimerDisplay();
        }

        function formatDuration(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            if (workoutHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic text-center p-4">No workout history found yet. Complete a session to see it here!</p>';
                return;
            }

            container.innerHTML = workoutHistory.map(session => {
                const dateStr = new Date(session.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const durationStr = formatDuration(session.totalDuration || 0);
                const presetLabel = session.presetName || 'N/A';
                
                return `
                    <div class="mb-4 p-4 bg-white rounded-xl shadow-md border-l-4 border-green-500">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="text-lg font-bold text-gray-800">
                                ${presetLabel} Workout
                            </h4>
                            <span class="text-sm font-semibold text-green-700">${durationStr} Total</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-2">${dateStr}</p>
                        <p class="text-xs text-gray-700 mb-3">Notes: ${session.notes || 'N/A'}</p>
                        <div class="mt-3 space-y-2 border-t pt-2">
                            ${session.exercises.map(ex => {
                                const isTimed = EXERCISE_LIBRARY[ex.name]?.isTimed || false;
                                const unit = isTimed ? 's' : 'kg';
                                
                                // Generate summary string for all recorded sets
                                const setSummary = ex.sets.map((set, i) => {
                                    if (set.reps !== null && set.reps !== undefined) {
                                        // If not timed, include weight if present
                                        if (!isTimed && set.weight !== null && set.weight !== undefined) {
                                            return `${set.reps}x${set.weight}${unit}`;
                                        } 
                                        // If timed, reps is the time, ignore weight
                                        else if (isTimed) {
                                            return `${set.reps}${unit}`;
                                        }
                                        // Standard reps only
                                        else {
                                            return `${set.reps} reps`;
                                        }
                                    }
                                    return '';
                                }).filter(s => s).join(', ');

                                return setSummary.length > 0 ? `
                                    <p class="text-sm text-gray-600">
                                        <span class="font-semibold text-indigo-700">${ex.name}:</span> ${setSummary}
                                    </p>
                                ` : '';
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showMessage(text, type) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = text;
            messageBox.className = 'p-3 rounded-lg text-white font-medium mb-4 transition-opacity duration-300';
            messageBox.classList.add(type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500');
            messageBox.style.opacity = 1;
            setTimeout(() => {
                messageBox.style.opacity = 0;
            }, 3000);
        }
        
        // --- NAVIGATION & INIT ---
        function navigate(view) {
            const trackerView = document.getElementById('tracker-view');
            const historyView = document.getElementById('history-view');
            const trackerTab = document.getElementById('tracker-tab');
            const historyTab = document.getElementById('history-tab');

            if (view === 'tracker') {
                trackerView.classList.remove('hidden');
                historyView.classList.add('hidden');
                trackerTab.classList.add('bg-indigo-700', 'text-white');
                trackerTab.classList.remove('bg-gray-200', 'text-gray-700');
                historyTab.classList.remove('bg-indigo-700', 'text-white');
                historyTab.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                trackerView.classList.add('hidden');
                historyView.classList.remove('hidden');
                historyTab.classList.add('bg-indigo-700', 'text-white');
                historyTab.classList.remove('bg-gray-200', 'text-gray-700');
                trackerTab.classList.remove('bg-indigo-700', 'text-white');
                trackerTab.classList.add('bg-gray-200', 'text-gray-700');
                
                loadHistory(); // Ensure history is fresh when navigating to it
            }
        }
        
        window.onload = () => {
            initializeFirebase();
            
            // Expose functions globally for inline HTML event handlers
            window.handleInputChange = handleInputChange;
            window.handleNotesChange = handleNotesChange;
            window.navigate = navigate;
            window.startNewSession = startNewSession;
            window.startRestTimer = startRestTimer;
            window.resetRestTimer = resetRestTimer;
            window.addExerciseToCurrentSession = addExerciseToCurrentSession;
            window.removeExerciseFromCurrentSession = removeExerciseFromCurrentSession;
            
            navigate('tracker'); 
            updateRestTimerDisplay(); 
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        #message-box {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="min-h-screen p-4">

    <div id="message-box"></div>

    <div class="max-w-xl mx-auto">
        <!-- Header and Status -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-indigo-800">Strength Tracker V3</h1>
            <p class="text-sm text-gray-500 mt-1">Total Time, Presets, and Customization</p>
            <div id="auth-status" class="mt-2 text-xs text-gray-600">
                Status: <span id="app-status" class="font-medium text-blue-600">Initializing...</span> | 
                <span id="user-id-display" class="break-words"></span>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex mb-6 rounded-lg overflow-hidden shadow-md">
            <button id="tracker-tab" onclick="navigate('tracker')" 
                    class="flex-1 p-3 text-center transition duration-200 font-bold bg-indigo-700 text-white">
                Current Workout
            </button>
            <button id="history-tab" onclick="navigate('history')" 
                    class="flex-1 p-3 text-center transition duration-200 font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">
                History Log
            </button>
        </div>

        <!-- Workout Tracker View -->
        <div id="tracker-view">
            
            <!-- Total Workout Timer (Chronometer) -->
            <div class="mb-6 p-4 bg-white rounded-xl shadow-lg border-b-4 border-green-500 text-center">
                <h2 class="text-xl font-bold text-green-600 mb-2">Total Session Time</h2>
                <span id="workout-timer-display" class="text-5xl font-extrabold text-gray-800">00:00:00</span>
                <p class="text-xs text-gray-500 mt-1">Starts automatically with a new preset.</p>
            </div>

            <!-- Preset Buttons -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Start New Session Preset:</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button onclick="startNewSession('Full Body')" 
                            class="p-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold rounded-lg shadow-md transition text-sm">
                        Full Body
                    </button>
                    <button onclick="startNewSession('Push')" 
                            class="p-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg shadow-md transition text-sm">
                        Push Day
                    </button>
                    <button onclick="startNewSession('Pull')" 
                            class="p-3 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-lg shadow-md transition text-sm">
                        Pull Day
                    </button>
                    <button onclick="startNewSession('Legs')" 
                            class="p-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md transition text-sm">
                        Legs Day
                    </button>
                </div>
            </div>
            
            <!-- Rest Timer Component -->
            <div class="mb-6 p-4 bg-white rounded-xl shadow-lg border-b-4 border-indigo-400 text-center">
                <h2 class="text-xl font-bold text-indigo-600 mb-2">Rest Timer (90s)</h2>
                
                <div class="mb-4">
                    <span id="rest-timer-display" class="text-5xl font-extrabold text-gray-800">01:30</span>
                    <p id="rest-timer-status" class="text-sm text-gray-500 font-medium">Ready (90s)</p>
                </div>

                <div class="flex justify-center space-x-4">
                    <button id="rest-timer-start-pause" onclick="startRestTimer()"
                            class="py-2 px-4 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg shadow-md transition">
                        Start
                    </button>
                    <button onclick="resetRestTimer()"
                            class="py-2 px-4 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow-md transition">
                        Reset
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 italic">Use this for set-to-set recovery.</p>
            </div>

            <!-- Workout Exercise Tracker Container (Customization Panel is rendered here first) -->
            <div id="tracker-container" class="space-y-4">
                <!-- Exercises will be rendered here -->
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex justify-center space-x-4">
                <button id="save-button" 
                        class="py-3 px-10 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full shadow-lg transition duration-300 transform hover:scale-[1.02]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    Save Workout & Finish
                </button>
            </div>
        </div>

        <!-- History Log View -->
        <div id="history-view" class="hidden">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Recent Sessions</h3>
            <div id="history-container" class="space-y-4">
                <!-- History will be rendered here -->
            </div>
        </div>

    </div>
</body>
</html>